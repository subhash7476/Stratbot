{% extends "base.html" %}

{% block title %}Backtest - opencode{% endblock %}

{% block breadcrumb %}Strategy / Backtest{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Strategy Backtesting</h1>
            <p class="text-slate-400 mt-1">Simulate strategies on historical data to validate performance.</p>
        </div>
        <button onclick="toggleNewBacktest()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-xl shadow-lg shadow-blue-500/20 transition-all flex items-center font-bold">
            <i class="fas fa-plus mr-2"></i> New Backtest
        </button>
    </div>

    <!-- New Backtest Form (Hidden by default) -->
    <div id="new-backtest-panel" class="hidden glass rounded-2xl p-8 border-blue-500/30 bg-blue-500/5 animate-in fade-in slide-in-from-top-4 duration-300">
        <h2 class="text-xl font-bold text-white mb-6">Configure Backtest</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Strategy</label>
                <select id="strategy-select" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                    <option value="">Loading strategies...</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Symbol</label>
                <div class="relative">
                    <input type="text" id="symbol-input" list="symbol-list" placeholder="Search symbol (e.g. RELIANCE)..." class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                    <datalist id="symbol-list">
                        <!-- Options will be populated dynamically -->
                    </datalist>
                </div>
                <p class="text-[10px] text-slate-500 italic">Supports FO Stocks, Indices, and MCX</p>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Capital</label>
                <input type="number" id="capital-input" value="100000" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Start Date</label>
                <input type="date" id="start-date-input" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">End Date</label>
                <input type="date" id="end-date-input" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mt-6">
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Timeframe</label>
                <select id="timeframe-select" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m">15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="1d">1 Day</option>
                </select>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Take Profit (TP %)</label>
                <input type="number" id="tp-pct-input" step="0.1" value="0.6" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                <p class="text-[10px] text-slate-500 italic">Example: 0.6 for 0.6%</p>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Stop Loss (SL %)</label>
                <input type="number" id="sl-pct-input" step="0.1" value="0.3" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                <p class="text-[10px] text-slate-500 italic">Example: 0.3 for 0.3%</p>
            </div>
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Max Hold Bars</label>
                <input type="number" id="max-hold-input" value="15" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500">
                <p class="text-[10px] text-slate-500 italic">Auto-exit after N bars</p>
            </div>
            <div class="flex items-end">
                <button id="run-backtest-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-lg shadow-emerald-500/20">
                    Run Simulation
                </button>
            </div>
        </div>
    </div>

    <!-- Backtest Status Panel -->
    <div id="backtest-status-panel" class="hidden glass rounded-2xl p-6 border-green-500/30 bg-green-500/5 mb-8">
        <div class="flex justify-between items-center">
            <h3 class="font-bold text-white">Backtest Status</h3>
            <button id="close-status-btn" class="text-slate-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mt-4">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <div class="text-slate-400 text-sm">Status</div>
                    <div id="backtest-status" class="text-white font-bold">PENDING</div>
                </div>
                <div class="flex-1">
                    <div class="text-slate-400 text-sm">Progress</div>
                    <div id="backtest-progress" class="text-white">Initializing...</div>
                </div>
                <div class="flex-1">
                    <div class="text-slate-400 text-sm">Duration</div>
                    <div id="backtest-duration" class="text-white">0s</div>
                </div>
            </div>
            <div class="mt-4">
                <div class="text-slate-400 text-sm">Messages</div>
                <div id="backtest-messages" class="mt-2 text-white text-sm bg-slate-800/50 p-3 rounded-lg h-24 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Recent Backtests -->
    <div class="glass rounded-2xl overflow-hidden">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-white">Recent Simulations</h3>
            <div class="flex space-x-2">
                <span class="px-3 py-1 bg-emerald-500/10 text-emerald-500 text-[10px] font-bold rounded-full border border-emerald-500/20">85% Success</span>
                <span class="px-3 py-1 bg-blue-500/10 text-blue-500 text-[10px] font-bold rounded-full border border-blue-500/20">12 Total</span>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-800/50 text-slate-400 uppercase text-[10px] font-bold tracking-widest">
                    <tr>
                        <th class="px-6 py-4">Strategy</th>
                        <th class="px-6 py-4">Instrument</th>
                        <th class="px-6 py-4">Returns</th>
                        <th class="px-6 py-4">Drawdown</th>
                        <th class="px-6 py-4">Win Rate</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Action</th>
                    </tr>
                </thead>
                <tbody id="recent-runs-table" class="divide-y divide-slate-800 text-slate-300">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics Dashboard Mock -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="glass p-6 rounded-2xl">
            <h3 class="font-bold text-white mb-6">Equity Growth (Last Run)</h3>
            <div id="backtest-equity-chart"></div>
        </div>
        <div class="glass p-6 rounded-2xl">
            <h3 class="font-bold text-white mb-6">Trade Distribution</h3>
            <div id="backtest-distribution-chart"></div>
        </div>
    </div>

    <!-- Trade List Section -->
    <div id="trade-list-panel" class="hidden glass rounded-2xl overflow-hidden mt-8">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800/30">
            <h3 class="font-bold text-white">Execution Log: <span id="trade-list-title" class="text-blue-400">Run Details</span></h3>
            <button onclick="document.getElementById('trade-list-panel').classList.add('hidden')" class="text-slate-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="overflow-x-auto max-h-[500px]">
            <table class="w-full text-left text-sm">
                <thead class="bg-slate-800/50 text-slate-400 uppercase text-[10px] font-bold tracking-widest sticky top-0">
                    <tr>
                        <th class="px-6 py-4">Symbol</th>
                        <th class="px-6 py-4">Entry Time</th>
                        <th class="px-6 py-4">Exit Time</th>
                        <th class="px-6 py-4">Entry Price</th>
                        <th class="px-6 py-4">Exit Price</th>
                        <th class="px-6 py-4">PnL</th>
                        <th class="px-6 py-4">Status</th>
                    </tr>
                </thead>
                <tbody id="trade-list-body" class="divide-y divide-slate-800 text-slate-300">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    function toggleNewBacktest() {
        const panel = document.getElementById('new-backtest-panel');
        panel.classList.toggle('hidden');
    }

    // Load strategies dynamically
    async function loadStrategies() {
        try {
            const response = await fetch('/backtest/api/strategies');
            const data = await response.json();

            const selectElement = document.getElementById('strategy-select');
            selectElement.innerHTML = '<option value="">Select a strategy</option>';

            if (data.success && data.strategies) {
                data.strategies.forEach(strategy => {
                    const option = document.createElement('option');
                    option.value = strategy.id;
                    option.textContent = strategy.name;
                    selectElement.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading strategies:', error);
            const selectElement = document.getElementById('strategy-select');
            selectElement.innerHTML = '<option value="">Error loading strategies</option>';
        }
    }

    // Global caches
    let symbolMap = {};

    // Load symbols dynamically
    async function loadSymbols() {
        try {
            const response = await fetch('/backtest/api/symbols');
            const data = await response.json();

            const datalist = document.getElementById('symbol-list');
            if (datalist) {
                datalist.innerHTML = '';
                symbolMap = {};

                if (data.success && data.symbols) {
                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol.label;
                        datalist.appendChild(option);
                        symbolMap[symbol.label] = symbol.value; // Map label to instrument_key
                    });
                }
            }
        } catch (error) {
            console.error('Error loading symbols:', error);
            const input = document.getElementById('symbol-input');
            if (input) input.placeholder = "Error loading symbols";
        }
    }

    // Chart instances
    let equityChart;
    let distributionChart;
    let currentRuns = [];

    // Call the function when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadStrategies();
        loadSymbols();
        loadRecentRuns(); // Load recent runs on page load

        // Initialize charts
        initCharts();

        // Add event listener to the run backtest button
        const runBtn = document.getElementById('run-backtest-btn');
        if (runBtn) {
            runBtn.addEventListener('click', runBacktest);
        }

        // Add event listener to the close status button
        const closeBtn = document.getElementById('close-status-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', hideBacktestStatus);
        }
    });

    function initCharts() {
        // Equity Chart
        const equityOptions = {
            series: [{ name: 'Equity', data: [] }],
            chart: { type: 'line', height: 300, toolbar: { show: false }, background: 'transparent' },
            stroke: { curve: 'smooth', width: 3 },
            colors: ['#10b981'],
            xaxis: { type: 'datetime', labels: { style: { colors: '#64748b' } } },
            yaxis: { labels: { style: { colors: '#64748b' } } },
            grid: { borderColor: '#334155' },
            theme: { mode: 'dark' },
            noData: { text: 'Select a run to view equity growth', style: { color: '#64748b' } }
        };
        equityChart = new ApexCharts(document.querySelector("#backtest-equity-chart"), equityOptions);
        equityChart.render();

        // Distribution Chart
        const distOptions = {
            series: [],
            chart: { type: 'donut', height: 300, background: 'transparent' },
            labels: ['Winning Long', 'Winning Short', 'Losing Long', 'Losing Short'],
            colors: ['#10b981', '#34d399', '#f43f5e', '#fb7185'],
            legend: { position: 'bottom', labels: { colors: '#94a3b8' } },
            theme: { mode: 'dark' },
            plotOptions: { pie: { donut: { size: '70%' } } },
            noData: { text: 'No trade data', style: { color: '#64748b' } }
        };
        distributionChart = new ApexCharts(document.querySelector("#backtest-distribution-chart"), distOptions);
        distributionChart.render();
    }

    // Function to run backtest
    async function runBacktest() {
        const strategySelect = document.getElementById('strategy-select');
        const symbolInput = document.getElementById('symbol-input');
        const capitalInput = document.getElementById('capital-input');
        const startDateInput = document.getElementById('start-date-input');
        const endDateInput = document.getElementById('end-date-input');
        const tpInput = document.getElementById('tp-pct-input');
        const slInput = document.getElementById('sl-pct-input');
        const maxHoldInput = document.getElementById('max-hold-input');
        const timeframeSelect = document.getElementById('timeframe-select');

        const strategyId = strategySelect.value;
        const symbolLabel = symbolInput.value;
        const instrumentKey = symbolMap[symbolLabel];
        
        const capital = parseFloat(capitalInput.value);
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        
        const tpPct = parseFloat(tpInput.value) / 100;
        const slPct = parseFloat(slInput.value) / 100;
        const maxHold = parseInt(maxHoldInput.value);

        if (!strategyId || !instrumentKey || !capital || !startDate || !endDate) {
            alert('Please fill all required fields and select a valid symbol from the list');
            return;
        }

        showBacktestStatus();
        updateBacktestStatus('INITIALIZING', 'Setting up backtest...', '0s', 'Starting backtest...');

        const runBtn = document.getElementById('run-backtest-btn');
        const originalText = runBtn.textContent;
        runBtn.disabled = true;
        runBtn.textContent = 'Running...';

        try {
            const response = await fetch('/backtest/api/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    strategy_id: strategyId, symbol: instrumentKey, capital: capital,
                    start_date: startDate, end_date: endDate,
                    tp_pct: tpPct, sl_pct: slPct, max_hold_bars: maxHold,
                    timeframe: timeframeSelect.value
                })
            });

            const result = await response.json();
            if (result.success) {
                updateBacktestStatus('STARTED', 'Backtest submitted', '0s', 'Backtest job queued');
                pollBacktestStatus(result.run_id);
            } else {
                updateBacktestStatus('FAILED', 'Error occurred', '0s', `Error: ${result.error || result.message}`);
                alert(`Error: ${result.error || result.message}`);
            }
        } catch (error) {
            console.error('Error:', error);
            updateBacktestStatus('FAILED', 'Connection error', '0s', `Error: ${error.message}`);
        } finally {
            runBtn.disabled = false;
            runBtn.textContent = originalText;
        }
    }

    async function pollBacktestStatus(runId) {
        const startTime = Date.now();
        const pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/backtest/api/runs`);
                const result = await response.json();

                if (result.success && result.runs) {
                    const run = result.runs.find(r => r.run_id === runId);
                    if (run) {
                        const duration = Math.floor((Date.now() - startTime)/1000);
                        if (run.status === 'COMPLETED') {
                            clearInterval(pollInterval);
                            updateBacktestStatus('COMPLETED', 'Finished', `${duration}s`, `Completed: ${run.total_trades} trades`);
                            loadRecentRuns();
                            showRunDetails(runId, run.symbol);
                        } else if (run.status === 'FAILED') {
                            clearInterval(pollInterval);
                            updateBacktestStatus('FAILED', 'Failed', `${duration}s`, `Error: ${run.error_message}`);
                            loadRecentRuns();
                        } else {
                            updateBacktestStatus(run.status, 'Processing...', `${duration}s`, `Status: ${run.status}`);
                        }
                    }
                }
            } catch (error) {
                console.error('Error polling:', error);
                clearInterval(pollInterval);
            }
        }, 2000);
    }

    async function loadRecentRuns() {
        try {
            const response = await fetch('/backtest/api/runs');
            const result = await response.json();
            if (result.success && result.runs) {
                currentRuns = result.runs;
                updateRecentRunsTable(result.runs);
                const latestCompleted = result.runs.find(r => r.status === 'COMPLETED');
                if (latestCompleted && document.getElementById('trade-list-panel').classList.contains('hidden')) {
                    showRunDetails(latestCompleted.run_id, latestCompleted.symbol);
                }
            }
        } catch (error) { console.error('Error:', error); }
    }

    async function showRunDetails(runId, symbol) {
        try {
            const response = await fetch(`/backtest/api/runs/${runId}/trades`);
            const result = await response.json();

            if (result.success && result.trades) {
                const panel = document.getElementById('trade-list-panel');
                const body = document.getElementById('trade-list-body');
                const title = document.getElementById('trade-list-title');

                title.textContent = `${symbol} (${runId.substring(0, 8)})`;
                body.innerHTML = '';

                const runInfo = currentRuns.find(r => r.run_id === runId);
                let initialCapital = 100000;
                if (runInfo && runInfo.params) {
                    try {
                        const params = typeof runInfo.params === 'string' ? JSON.parse(runInfo.params) : runInfo.params;
                        initialCapital = params.capital || 100000;
                    } catch (e) {}
                }

                if (result.trades.length === 0) {
                    body.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No trades executed</td></tr>';
                    updateCharts([], initialCapital);
                } else {
                    result.trades.forEach(trade => {
                        const pnlClass = trade.pnl >= 0 ? 'text-emerald-400' : 'text-rose-400';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 font-mono text-xs">${trade.symbol}</td>
                            <td class="px-6 py-4 text-xs">${new Date(trade.entry_ts).toLocaleString()}</td>
                            <td class="px-6 py-4 text-xs">${new Date(trade.exit_ts).toLocaleString()}</td>
                            <td class="px-6 py-4 font-mono">₹${trade.entry_price.toFixed(2)}</td>
                            <td class="px-6 py-4 font-mono">₹${trade.exit_price.toFixed(2)}</td>
                            <td class="px-6 py-4 font-bold ${pnlClass}">₹${trade.pnl.toFixed(2)}</td>
                            <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-slate-800 text-[10px]">CLOSED</span></td>
                        `;
                        body.appendChild(row);
                    });
                    updateCharts(result.trades, initialCapital);
                }
                panel.classList.remove('hidden');
                panel.scrollIntoView({ behavior: 'smooth' });
            }
        } catch (error) { console.error('Error:', error); }
    }

    function updateCharts(trades, initialCapital) {
        if (!equityChart || !distributionChart) return;
        let winLong = 0, winShort = 0, lossLong = 0, lossShort = 0;
        trades.forEach(t => {
            const isWin = t.pnl > 0;
            const isLong = t.direction === 'LONG' || t.direction === 'BUY';
            if (isWin && isLong) winLong++;
            else if (isWin && !isLong) winShort++;
            else if (!isWin && isLong) lossLong++;
            else lossShort++;
        });
        distributionChart.updateSeries([winLong, winShort, lossLong, lossShort]);

        let currentEquity = initialCapital;
        const equityData = trades.length > 0 ? [{ x: new Date(trades[0].entry_ts).getTime() - 60000, y: initialCapital }] : [];
        const sortedTrades = [...trades].sort((a, b) => new Date(a.exit_ts) - new Date(b.exit_ts));
        sortedTrades.forEach(t => {
            currentEquity += (t.pnl - (t.fees || 0));
            equityData.push({ x: new Date(t.exit_ts).getTime(), y: parseFloat(currentEquity.toFixed(2)) });
        });
        equityChart.updateSeries([{ name: 'Equity', data: equityData }]);
    }

    function updateRecentRunsTable(runs) {
        const tbody = document.getElementById('recent-runs-table');
        tbody.innerHTML = '';
        if (!runs || runs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">No backtest runs found</td></tr>';
            return;
        }
        runs.forEach(run => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-700/30 transition-colors cursor-pointer group';
            row.onclick = () => showRunDetails(run.run_id, run.symbol);
            let statusHtml = `<span class="px-2 py-1 rounded bg-slate-800 text-[10px] text-slate-400 border border-slate-700">${run.status || 'PENDING'}</span>`;
            if (run.status === 'COMPLETED') statusHtml = `<span class="px-2 py-1 rounded bg-emerald-500/10 text-emerald-500 text-[10px] border border-emerald-500/20">${run.status}</span>`;
            else if (run.status === 'RUNNING') statusHtml = `<span class="px-2 py-1 rounded bg-blue-500/10 text-blue-500 text-[10px] border border-blue-500/20 flex items-center w-fit"><i class="fas fa-spinner fa-spin mr-1"></i> ${run.status}</span>`;
            else if (run.status === 'FAILED') statusHtml = `<span class="px-2 py-1 rounded bg-rose-500/10 text-rose-500 text-[10px] border border-rose-500/20">${run.status}</span>`;

            row.innerHTML = `
                <td class="px-6 py-4 font-medium text-white">${run.strategy_id || 'N/A'}</td>
                <td class="px-6 py-4">${run.symbol || 'N/A'}</td>
                <td class="px-6 py-4 text-emerald-400 font-bold">${run.total_pnl ? '₹' + run.total_pnl.toLocaleString(undefined, {minimumFractionDigits: 2}) : 'N/A'}</td>
                <td class="px-6 py-4 text-rose-400">${run.max_drawdown ? run.max_drawdown.toFixed(2) + '%' : 'N/A'}</td>
                <td class="px-6 py-4">${run.win_rate ? (run.win_rate * 100).toFixed(0) + '%' : 'N/A'}</td>
                <td class="px-6 py-4">${statusHtml}</td>
                <td class="px-6 py-4">
                    <div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); showRunDetails('${run.run_id}', '${run.symbol}')" class="text-blue-500 hover:text-blue-400 px-2 py-1"><i class="fas fa-chart-bar"></i></button>
                        <a href="/backtest/api/runs/${run.run_id}/trades/csv" onclick="event.stopPropagation()" class="text-amber-500 hover:text-amber-400 px-2 py-1"><i class="fas fa-file-csv"></i></a>
                        <button onclick="event.stopPropagation(); deleteRun('${run.run_id}')" class="text-rose-500 hover:text-rose-400 px-2 py-1"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function deleteRun(runId) {
        if (!confirm('Delete this backtest run?')) return;
        try {
            const response = await fetch(`/backtest/api/runs/${runId}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                loadRecentRuns();
                document.getElementById('trade-list-panel').classList.add('hidden');
            }
        } catch (error) { alert('Delete failed: ' + error.message); }
    }

    function showBacktestStatus() {
        const panel = document.getElementById('backtest-status-panel');
        panel.classList.remove('hidden');
        panel.scrollIntoView({ behavior: 'smooth' });
    }

    function hideBacktestStatus() {
        document.getElementById('backtest-status-panel').classList.add('hidden');
    }

    function updateBacktestStatus(status, progress, duration, message) {
        document.getElementById('backtest-status').textContent = status;
        document.getElementById('backtest-progress').textContent = progress;
        document.getElementById('backtest-duration').textContent = duration;
        if (message) {
            const messagesDiv = document.getElementById('backtest-messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

</script>
{% endblock %}
{% endblock %}
