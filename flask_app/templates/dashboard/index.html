{% extends "base.html" %}

{% block title %}Dashboard - Trading Bot Pro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold">Dashboard</h1>
            <p class="text-base-content/70">Overview of your trading system</p>
        </div>
        <div class="flex gap-2">
            <button class="btn btn-outline btn-sm" onclick="refreshStats()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Market Status -->
        <div class="card bg-base-100 shadow-xl card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/70 text-sm">Market Status</p>
                        <p class="text-2xl font-bold" id="stat-market-status">{{ stats.market_status }}</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-{{ 'success' if stats.market_status == 'Open' else 'error' }}/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-{{ 'success' if stats.market_status == 'Open' else 'error' }}">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Signals -->
        <div class="card bg-base-100 shadow-xl card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/70 text-sm">Active Signals</p>
                        <p class="text-2xl font-bold" id="stat-active-signals">{{ stats.active_signals }}</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instruments Tracked -->
        <div class="card bg-base-100 shadow-xl card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/70 text-sm">Instruments Tracked</p>
                        <p class="text-2xl font-bold" id="stat-instruments">{{ stats.instruments_tracked }}</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-secondary/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-secondary">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- WebSocket Status -->
        <div class="card bg-base-100 shadow-xl card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-base-content/70 text-sm">WebSocket</p>
                        <p class="text-2xl font-bold" id="stat-websocket">{{ stats.websocket_status }}</p>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-{{ 'success' if stats.websocket_status == 'Connected' else 'warning' }}/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-{{ 'success' if stats.websocket_status == 'Connected' else 'warning' }}">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.288 15.038a5.25 5.25 0 017.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 011.06 0z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions & Last Update -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Quick Actions -->
        <div class="card bg-base-100 shadow-xl lg:col-span-2">
            <div class="card-body">
                <h2 class="card-title">Quick Actions</h2>
                <div class="divider my-2"></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <a href="{{ url_for('scanner.index') }}" class="btn btn-primary btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                        </svg>
                        Run Scan
                    </a>
                    <a href="{{ url_for('data.index') }}" class="btn btn-secondary btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        Fetch Data
                    </a>
                    <a href="{{ url_for('options.index') }}" class="btn btn-accent btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                        </svg>
                        Options
                    </a>
                    <a href="{{ url_for('database.index') }}" class="btn btn-info btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                        </svg>
                        Database
                    </a>
                </div>
            </div>
        </div>

        <!-- Last Data Update -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Data Status</h2>
                <div class="divider my-2"></div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-base-content/70">Last Update</span>
                        <span class="font-mono text-sm" id="stat-last-update">
                            {% if stats.last_data_update %}
                                {{ format_datetime(stats.last_data_update) }}
                            {% else %}
                                Never
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base-content/70">Today's Trades</span>
                        <span class="font-bold" id="stat-todays-trades">{{ stats.todays_trades }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Signals Table -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <h2 class="card-title">Recent Signals</h2>
                <a href="{{ url_for('scanner.index') }}" class="btn btn-ghost btn-sm">View All</a>
            </div>
            <div class="divider my-2"></div>
            <div class="overflow-x-auto">
                <table class="table table-compact w-full" id="signals-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Type</th>
                            <th>Entry</th>
                            <th>SL</th>
                            <th>TP</th>
                            <th>Score</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="signals-tbody">
                        <tr>
                            <td colspan="8" class="text-center text-base-content/50 py-8">
                                Loading signals...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Refresh stats
    async function refreshStats() {
        try {
            const response = await fetch('{{ url_for("dashboard.stats") }}');
            const data = await response.json();

            document.getElementById('stat-market-status').textContent = data.market_status;
            document.getElementById('stat-active-signals').textContent = data.active_signals;
            document.getElementById('stat-instruments').textContent = data.instruments_tracked;
            document.getElementById('stat-websocket').textContent = data.websocket_status;

            if (data.last_data_update) {
                document.getElementById('stat-last-update').textContent = new Date(data.last_data_update).toLocaleString();
            }

            showToast('Stats refreshed', 'success');
        } catch (error) {
            console.error('Error refreshing stats:', error);
            showToast('Failed to refresh stats', 'error');
        }
    }

    // Load recent signals
    async function loadSignals() {
        try {
            const response = await fetch('{{ url_for("scanner.signals") }}?status=active');
            const data = await response.json();

            const tbody = document.getElementById('signals-tbody');

            if (!data.success || !data.signals || data.signals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-base-content/50 py-8">
                            No active signals
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.signals.slice(0, 10).map(signal => `
                <tr class="hover">
                    <td class="font-medium">${signal.symbol}</td>
                    <td>
                        <span class="badge badge-${signal.signal_type === 'LONG' ? 'success' : 'error'} badge-sm">
                            ${signal.signal_type}
                        </span>
                    </td>
                    <td class="font-mono">${formatPrice(signal.entry_price)}</td>
                    <td class="font-mono text-error">${formatPrice(signal.sl_price)}</td>
                    <td class="font-mono text-success">${formatPrice(signal.tp_price)}</td>
                    <td>
                        <div class="badge badge-${signal.score >= 5 ? 'primary' : 'warning'} badge-sm">
                            ${signal.score}
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-${signal.status === 'active' ? 'info' : signal.status === 'triggered' ? 'success' : 'ghost'} badge-sm">
                            ${signal.status}
                        </span>
                    </td>
                    <td class="text-sm text-base-content/70">
                        ${signal.created_at ? new Date(signal.created_at).toLocaleTimeString() : '-'}
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Error loading signals:', error);
            document.getElementById('signals-tbody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-error py-8">
                        Error loading signals
                    </td>
                </tr>
            `;
        }
    }

    // Initial load
    loadSignals();

    // Auto-refresh every 30 seconds
    setInterval(() => {
        refreshStats();
        loadSignals();
    }, 30000);
</script>
{% endblock %}
