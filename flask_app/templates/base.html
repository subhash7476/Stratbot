<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Trading Bot Pro{% endblock %}</title>

    <!-- TailwindCSS + DaisyUI via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Heroicons (for icons) -->
    <script src="https://unpkg.com/heroicons@2.0.18/24/outline/index.js"></script>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

    <!-- Custom styles -->
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: hsl(var(--b2));
        }
        ::-webkit-scrollbar-thumb {
            background: hsl(var(--bc) / 0.3);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--bc) / 0.5);
        }

        /* Table styling */
        .table-compact th, .table-compact td {
            padding: 0.5rem 0.75rem;
        }

        /* Status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.connected { background: #22c55e; }
        .status-dot.disconnected { background: #ef4444; }
        .status-dot.pending { background: #eab308; }

        /* Price colors */
        .price-up { color: #22c55e; }
        .price-down { color: #ef4444; }
        .price-neutral { color: hsl(var(--bc)); }

        /* Card hover effect */
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Loading spinner */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>

    {% block head %}{% endblock %}
</head>
<body class="min-h-screen bg-base-200">
    <!-- Navbar -->
    <div class="navbar bg-base-100 shadow-lg sticky top-0 z-50">
        <div class="navbar-start">
            <div class="dropdown">
                <div tabindex="0" role="button" class="btn btn-ghost lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
                    </svg>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                    {% for item in nav_items %}
                    <li>
                        <a href="{{ url_for(item.endpoint) }}" class="{% if request.endpoint and request.endpoint.startswith(item.endpoint.split('.')[0]) %}active{% endif %}">
                            {{ item.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-ghost text-xl">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                </svg>
                <span class="font-bold">Trading Bot Pro</span>
            </a>
        </div>

        <div class="navbar-center hidden lg:flex">
            <ul class="menu menu-horizontal px-1">
                {% for item in nav_items %}
                <li>
                    <a href="{{ url_for(item.endpoint) }}" class="{% if request.endpoint and request.endpoint.startswith(item.endpoint.split('.')[0]) %}active{% endif %}">
                        {{ item.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="navbar-end gap-2">
            <!-- Market Status Indicator -->
            <div class="flex items-center gap-2 px-3 py-1 bg-base-200 rounded-lg">
                <span id="market-status-dot" class="status-dot disconnected"></span>
                <span id="market-status-text" class="text-sm">Market Closed</span>
            </div>

            <!-- WebSocket Status -->
            <div class="tooltip tooltip-bottom" data-tip="WebSocket Status">
                <div id="ws-status" class="badge badge-error gap-1">
                    <span class="status-dot disconnected"></span>
                    WS
                </div>
            </div>

            <!-- Theme Toggle -->
            <label class="swap swap-rotate btn btn-ghost btn-circle">
                <input type="checkbox" id="theme-toggle" class="theme-controller" value="light" />
                <svg class="swap-on fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
                </svg>
                <svg class="swap-off fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
                </svg>
            </label>

            <!-- User Menu -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div class="w-10 rounded-full bg-primary text-primary-content flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                    </div>
                </div>
                <ul tabindex="0" class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52">
                    <li><a href="{{ url_for('auth.login') }}">Settings</a></li>
                    <li><a href="{{ url_for('auth.logout') }}">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="fixed top-20 right-4 z-50 flex flex-col gap-2" id="flash-messages">
            {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'error' if category == 'error' else 'warning' if category == 'warning' else 'info' }} shadow-lg fade-in">
                <span>{{ message }}</span>
                <button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">×</button>
            </div>
            {% endfor %}
        </div>
        <script>
            // Auto-dismiss flash messages after 5 seconds
            setTimeout(() => {
                document.querySelectorAll('#flash-messages .alert').forEach(el => {
                    el.style.opacity = '0';
                    el.style.transition = 'opacity 0.3s';
                    setTimeout(() => el.remove(), 300);
                });
            }, 5000);
        </script>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer footer-center p-4 bg-base-100 text-base-content mt-auto">
        <aside>
            <p>Trading Bot Pro - <span id="current-time">{{ now().strftime('%H:%M:%S') }}</span></p>
        </aside>
    </footer>

    <!-- Global Scripts -->
    <script>
        // Theme persistence
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.checked = savedTheme === 'light';

        themeToggle.addEventListener('change', (e) => {
            const theme = e.target.checked ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });

        // Clock update
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-IN', { hour12: false });
            const clockEl = document.getElementById('current-time');
            if (clockEl) clockEl.textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Market status check
        function checkMarketStatus() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const time = hours * 60 + minutes;

            const marketOpen = 9 * 60 + 15;  // 9:15
            const marketClose = 15 * 60 + 30; // 15:30
            const day = now.getDay();

            const isWeekday = day >= 1 && day <= 5;
            const isMarketHours = time >= marketOpen && time <= marketClose;
            const isOpen = isWeekday && isMarketHours;

            const dot = document.getElementById('market-status-dot');
            const text = document.getElementById('market-status-text');

            if (dot && text) {
                if (isOpen) {
                    dot.className = 'status-dot connected';
                    text.textContent = 'Market Open';
                } else {
                    dot.className = 'status-dot disconnected';
                    text.textContent = 'Market Closed';
                }
            }
        }
        setInterval(checkMarketStatus, 60000);
        checkMarketStatus();

        // Utility functions
        window.formatPrice = (value) => {
            if (value === null || value === undefined) return '-';
            return '₹' + parseFloat(value).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        window.formatPercent = (value) => {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            const sign = num >= 0 ? '+' : '';
            return sign + num.toFixed(2) + '%';
        };

        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('flash-messages') || (() => {
                const div = document.createElement('div');
                div.id = 'flash-messages';
                div.className = 'fixed top-20 right-4 z-50 flex flex-col gap-2';
                document.body.appendChild(div);
                return div;
            })();

            const alert = document.createElement('div');
            alert.className = `alert alert-${type} shadow-lg fade-in`;
            alert.innerHTML = `<span>${message}</span><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">×</button>`;
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        };
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
