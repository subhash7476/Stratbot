{% extends "base.html" %}

{% block title %}Database Explorer - opencode{% endblock %}

{% block breadcrumb %}System / Database{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Database Explorer</h1>
            <p class="text-slate-400 mt-1">Manage and inspect your DuckDB data layers.</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="loadTables()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-xl border border-slate-700 transition-colors flex items-center">
                <i class="fas fa-sync-alt mr-2"></i> Refresh
            </button>
            <button class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl shadow-lg shadow-blue-500/20 transition-all flex items-center">
                <i class="fas fa-terminal mr-2"></i> SQL Console
            </button>
        </div>
    </div>

    <!-- Upstox Data Fetcher Card -->
    <div class="glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-purple-500/10 rounded-xl flex items-center justify-center text-purple-500">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white">Upstox Data Fetcher</h2>
                    <p class="text-xs text-slate-400 uppercase tracking-tighter">Fetch historical market data</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <!-- Instrument Key Input -->
            <div class="lg:col-span-2">
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Instrument</label>
                <div class="relative">
                    <input
                        type="text"
                        id="instrumentInput"
                        placeholder="Search instrument..."
                        class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        autocomplete="off"
                    >
                    <div id="instrumentSuggestions" class="absolute z-10 w-full bg-slate-800 border border-slate-700 rounded-lg mt-1 hidden">
                        <!-- Suggestions will appear here -->
                    </div>
                </div>
            </div>

            <!-- Unit Selector -->
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Unit</label>
                <select id="unitSelector" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="minutes">Minutes</option>
                    <option value="hours">Hours</option>
                    <option value="days">Days</option>
                    <option value="weeks">Weeks</option>
                    <option value="months">Months</option>
                </select>
            </div>

            <!-- Interval Input -->
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Interval</label>
                <input
                    type="number"
                    id="intervalInput"
                    placeholder="1"
                    min="1"
                    max="300"
                    value="1"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                >
            </div>

            <!-- From Date -->
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">From Date</label>
                <input
                    type="date"
                    id="fromDateInput"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                >
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- To Date -->
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">To Date</label>
                <input
                    type="date"
                    id="toDateInput"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                >
            </div>

            <!-- Action Buttons -->
            <div class="flex items-end space-x-3">
                <button
                    id="previewBtn"
                    onclick="fetchAndPreview()"
                    class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center"
                    disabled
                >
                    <i class="fas fa-eye mr-2"></i> Preview
                </button>
                <button
                    id="saveBtn"
                    onclick="fetchAndSave()"
                    class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 px-4 rounded-lg transition-colors flex items-center justify-center"
                    disabled
                >
                    <i class="fas fa-save mr-2"></i> Save to DB
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
            <span class="ml-3 text-slate-400">Fetching data...</span>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-500/20 border border-red-500/50 rounded-lg p-4 mb-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                <span id="errorText" class="text-red-300"></span>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-4">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                <span id="successText" class="text-green-300"></span>
            </div>
        </div>
    </div>

    <!-- Data Viewer Panel -->
    <div class="glass rounded-2xl p-6">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-blue-500/10 rounded-xl flex items-center justify-center text-blue-500">
                    <i class="fas fa-table text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white">Historical Data Viewer</h2>
                    <p class="text-xs text-slate-400 uppercase tracking-tighter" id="dataStats">Browse saved historical data</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="exportCsvBtn" onclick="exportToCsv()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm flex items-center">
                    <i class="fas fa-download mr-1"></i> Export CSV
                </button>
                <button id="toggleViewBtn" onclick="toggleTableView()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm">
                    <i class="fas fa-chart-bar mr-1"></i> Chart View
                </button>
            </div>
        </div>

        <!-- Filters for Saved Data -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Instrument</label>
                <select id="savedInstrumentFilter" class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Instruments</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">From Date</label>
                <input
                    type="date"
                    id="savedFromDateFilter"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>
            <div>
                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">To Date</label>
                <input
                    type="date"
                    id="savedToDateFilter"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-lg py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>
        </div>

        <!-- Data Table -->
        <div class="overflow-x-auto">
            <table id="dataTable" class="w-full text-left text-sm">
                <thead class="bg-slate-800/80 text-slate-400 uppercase text-[10px] font-bold tracking-widest">
                    <tr>
                        <th class="px-4 py-3">Timestamp</th>
                        <th class="px-4 py-3">Open</th>
                        <th class="px-4 py-3">High</th>
                        <th class="px-4 py-3">Low</th>
                        <th class="px-4 py-3">Close</th>
                        <th class="px-4 py-3">Volume</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="divide-y divide-slate-800 text-slate-300">
                    <tr>
                        <td colspan="6" class="px-4 py-20 text-center text-slate-500 italic">
                            Enter search criteria to view historical data
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="paginationControls" class="hidden mt-6 flex items-center justify-between">
            <div id="paginationInfo" class="text-slate-400 text-sm"></div>
            <div class="flex space-x-2">
                <button id="prevPageBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm" onclick="changePage(currentPage - 1)">
                    Previous
                </button>
                <span id="pageInfo" class="text-slate-400 text-sm px-2">Page 1 of 1</span>
                <button id="nextPageBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-sm" onclick="changePage(currentPage + 1)">
                    Next
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Sidebar: Tables List -->
        <div class="glass rounded-2xl overflow-hidden flex flex-col h-[600px]">
            <div class="p-4 border-b border-slate-700 bg-slate-800/30">
                <h3 class="text-xs font-bold uppercase tracking-widest text-slate-500 flex items-center">
                    <i class="fas fa-table mr-2"></i> Tables
                </h3>
            </div>
            <div id="table-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Tables populated here -->
                <div class="p-4 text-center text-slate-500 animate-pulse">Loading schema...</div>
            </div>
        </div>

        <!-- Main Content: Table Preview -->
        <div class="lg:col-span-3 space-y-6">
            <div class="glass rounded-2xl p-6 min-h-[400px] flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-blue-500/10 rounded-xl flex items-center justify-center text-blue-500">
                            <i class="fas fa-database text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white" id="selected-table-name">Select a table</h2>
                            <p class="text-xs text-slate-400 uppercase tracking-tighter" id="table-stats">0 Rows • 0 KB</p>
                        </div>
                    </div>
                    <div class="flex items-center bg-slate-800/50 rounded-lg p-1">
                        <button class="px-3 py-1 text-xs font-medium text-white bg-slate-700 rounded-md">Structure</button>
                        <button class="px-3 py-1 text-xs font-medium text-slate-400 hover:text-white rounded-md">Data Preview</button>
                    </div>
                </div>

                <div class="flex-1 border border-slate-700/50 rounded-xl overflow-hidden bg-slate-900/50">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800/80 text-slate-400 uppercase text-[10px] font-bold tracking-widest">
                            <tr>
                                <th class="px-6 py-3">Column Name</th>
                                <th class="px-6 py-3">Data Type</th>
                                <th class="px-6 py-3">Nullable</th>
                                <th class="px-6 py-3">Default</th>
                            </tr>
                        </thead>
                        <tbody id="table-preview-body" class="divide-y divide-slate-800 text-slate-300">
                            <tr>
                                <td colspan="4" class="px-6 py-20 text-center text-slate-500 italic">
                                    Click a table on the left to view its schema and data.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Database Info Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass p-5 rounded-2xl flex items-center space-x-4">
                    <div class="w-10 h-10 bg-emerald-500/10 rounded-lg flex items-center justify-center text-emerald-500">
                        <i class="fas fa-hdd"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Storage Path</p>
                        <p class="text-sm font-mono text-slate-300">data/trading_bot.duckdb</p>
                    </div>
                </div>
                <div class="glass p-5 rounded-2xl flex items-center space-x-4">
                    <div class="w-10 h-10 bg-amber-500/10 rounded-lg flex items-center justify-center text-amber-500">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-500 uppercase">Last Backup</p>
                        <p class="text-sm text-slate-300">2 hours ago</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Global variables for pagination
    let currentPage = 1;
    const itemsPerPage = 50;
    let totalItems = 0;
    let currentData = [];

    // Initialize date pickers with today and yesterday as defaults
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

        document.getElementById('fromDateInput').value = yesterday;
        document.getElementById('toDateInput').value = today;
        document.getElementById('savedFromDateFilter').value = yesterday;
        document.getElementById('savedToDateFilter').value = today;

        // Enable buttons when instrument is selected
        document.getElementById('instrumentInput').addEventListener('change', function() {
            const isValid = this.value.includes('|'); // Basic validation for instrument key format
            document.getElementById('previewBtn').disabled = !isValid;
            document.getElementById('saveBtn').disabled = !isValid;
        });

        // Setup interval validation based on unit selection
        document.getElementById('unitSelector').addEventListener('change', function() {
            const intervalInput = document.getElementById('intervalInput');
            const unit = this.value;

            // Reset to default value
            intervalInput.value = 1;

            // Set min/max based on unit
            if (unit === 'minutes') {
                intervalInput.min = 1;
                intervalInput.max = 300;
                intervalInput.placeholder = "1-300";
            } else if (unit === 'hours') {
                intervalInput.min = 1;
                intervalInput.max = 5;
                intervalInput.placeholder = "1-5";
            } else {
                intervalInput.min = 1;
                intervalInput.max = 1;
                intervalInput.placeholder = "1";
            }
        });

        // Load instruments for filter dropdown
        loadSavedInstruments();

        // Load initial data
        loadTables();
    });

    // Load instrument suggestions as user types
    document.getElementById('instrumentInput').addEventListener('input', debounce(function() {
        const searchTerm = this.value.trim();
        if (searchTerm.length >= 2) {
            fetchInstrumentSuggestions(searchTerm);
        } else {
            hideSuggestions();
        }
    }, 300));

    // Debounce function to limit API calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Fetch instrument suggestions
    async function fetchInstrumentSuggestions(searchTerm) {
        try {
            const response = await fetch(`/database/api/instruments-search?search_term=${encodeURIComponent(searchTerm)}`);
            const data = await response.json();

            if (data.success) {
                showSuggestions(data.instruments);
            } else {
                console.error('Error fetching instruments:', data.message);
            }
        } catch (error) {
            console.error('Error fetching instrument suggestions:', error);
        }
    }

    // Show instrument suggestions
    function showSuggestions(instruments) {
        const suggestionsDiv = document.getElementById('instrumentSuggestions');
        if (instruments.length === 0) {
            suggestionsDiv.classList.add('hidden');
            return;
        }

        suggestionsDiv.innerHTML = instruments.slice(0, 10).map(inst => `
            <div class="p-2 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-b-0"
                 onclick="selectInstrument('${inst.key}', '${inst.name}')">
                <div class="font-medium text-white text-sm">${inst.name}</div>
                <div class="text-xs text-slate-400">${inst.key}</div>
            </div>
        `).join('');

        suggestionsDiv.classList.remove('hidden');
    }

    // Hide suggestions
    function hideSuggestions() {
        document.getElementById('instrumentSuggestions').classList.add('hidden');
    }

    // Select an instrument from suggestions
    function selectInstrument(key, name) {
        document.getElementById('instrumentInput').value = key;
        hideSuggestions();

        // Enable buttons
        const isValid = key.includes('|');
        document.getElementById('previewBtn').disabled = !isValid;
        document.getElementById('saveBtn').disabled = !isValid;
    }

    // Fetch and preview data
    async function fetchAndPreview() {
        const instrumentKey = document.getElementById('instrumentInput').value;
        const unit = document.getElementById('unitSelector').value;
        const interval = parseInt(document.getElementById('intervalInput').value);
        const fromDate = document.getElementById('fromDateInput').value;
        const toDate = document.getElementById('toDateInput').value;

        // Validate inputs
        if (!instrumentKey || !unit || !interval || !fromDate || !toDate) {
            showError('Please fill in all fields');
            return;
        }

        showLoading(true);
        hideMessages();

        try {
            // For preview, we'll simulate a fetch by calling the save endpoint but not saving
            const response = await fetch('/database/api/request-historical-fetch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    instrument_key: instrumentKey,
                    unit: unit,
                    interval: interval,
                    from_date: fromDate,
                    to_date: toDate
                })
            });

            const data = await response.json();

            if (data.success) {
                showSuccess('Data fetched successfully. Use "Save to DB" to persist.');

                // Load the data into the table
                await loadHistoricalData(instrumentKey, fromDate, toDate);
            } else {
                showError(data.message || 'Failed to fetch data');
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showError('Network error. Please try again.');
        } finally {
            showLoading(false);
        }
    }

    // Fetch and save data to database
    async function fetchAndSave() {
        const instrumentKey = document.getElementById('instrumentInput').value;
        const unit = document.getElementById('unitSelector').value;
        const interval = parseInt(document.getElementById('intervalInput').value);
        const fromDate = document.getElementById('fromDateInput').value;
        const toDate = document.getElementById('toDateInput').value;

        // Validate inputs
        if (!instrumentKey || !unit || !interval || !fromDate || !toDate) {
            showError('Please fill in all fields');
            return;
        }

        showLoading(true);
        hideMessages();

        try {
            const response = await fetch('/database/api/request-historical-fetch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    instrument_key: instrumentKey,
                    unit: unit,
                    interval: interval,
                    from_date: fromDate,
                    to_date: toDate
                })
            });

            const data = await response.json();

            if (data.success) {
                showSuccess(data.message || 'Data fetch initiated successfully');

                // Load the data into the table
                await loadHistoricalData(instrumentKey, fromDate, toDate);

                // Reload the instrument filter options
                loadSavedInstruments();
            } else {
                showError(data.message || 'Failed to save data');
            }
        } catch (error) {
            console.error('Error saving data:', error);
            showError('Network error. Please try again.');
        } finally {
            showLoading(false);
        }
    }

    // Load historical data into the table
    async function loadHistoricalData(instrumentKey, fromDate, toDate, page = 1) {
        try {
            const offset = (page - 1) * itemsPerPage;
            const url = `/database/api/historical-data?instrument_key=${encodeURIComponent(instrumentKey)}&from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&limit=${itemsPerPage}&offset=${offset}`;

            const response = await fetch(url);
            const data = await response.json();

            if (data.success) {
                currentData = data.data;
                totalItems = data.total;
                currentPage = page;

                renderDataTable(currentData);
                updatePaginationControls();

                // Update stats
                document.getElementById('dataStats').textContent = `${totalItems} Records • ${fromDate} to ${toDate}`;
            } else {
                showError(data.message || 'Failed to load data');
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="7" class="px-4 py-20 text-center text-slate-500 italic">No data found</td></tr>';
            }
        } catch (error) {
            console.error('Error loading historical data:', error);
            showError('Network error while loading data');
        }
    }

    // Render data in the table
    function renderDataTable(data) {
        const tbody = document.getElementById('dataTableBody');

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-20 text-center text-slate-500 italic">No data found</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(row => {
            // Format the values
            const timestamp = new Date(row.timestamp).toLocaleString();
            const open = parseFloat(row.open).toFixed(2);
            const high = parseFloat(row.high).toFixed(2);
            const low = parseFloat(row.low).toFixed(2);
            const close = parseFloat(row.close).toFixed(2);
            const volume = parseInt(row.volume).toLocaleString();

            // Determine if price went up or down for color coding
            const priceChange = parseFloat(row.close) - parseFloat(row.open);
            const priceClass = priceChange >= 0 ? 'text-emerald-400' : 'text-rose-400';

            return `
                <tr class="hover:bg-slate-800/50">
                    <td class="px-4 py-3 font-mono text-xs">${timestamp}</td>
                    <td class="px-4 py-3 ${priceClass}">${open}</td>
                    <td class="px-4 py-3 ${priceClass}">${high}</td>
                    <td class="px-4 py-3 ${priceClass}">${low}</td>
                    <td class="px-4 py-3 ${priceClass}">${close}</td>
                    <td class="px-4 py-3 text-right">${volume}</td>
                </tr>
            `;
        }).join('');
    }

    // Update pagination controls
    function updatePaginationControls() {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        const paginationControls = document.getElementById('paginationControls');

        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;

        paginationInfo.textContent = `Showing ${Math.min((currentPage-1)*itemsPerPage + 1, totalItems)}-${Math.min(currentPage*itemsPerPage, totalItems)} of ${totalItems} records`;

        if (totalItems > 0) {
            paginationControls.classList.remove('hidden');
        } else {
            paginationControls.classList.add('hidden');
        }
    }

    // Change page
    function changePage(page) {
        if (page < 1) page = 1;

        const totalPages = Math.ceil(totalItems / itemsPerPage);
        if (page > totalPages) page = totalPages;

        if (page !== currentPage) {
            const instrumentKey = document.getElementById('instrumentInput').value;
            const fromDate = document.getElementById('fromDateInput').value;
            const toDate = document.getElementById('toDateInput').value;

            loadHistoricalData(instrumentKey, fromDate, toDate, page);
        }
    }

    // Load saved instruments for filter dropdown
    async function loadSavedInstruments() {
        try {
            // Get unique instrument keys from the fo_stocks_master table
            const response = await fetch('/database/api/instruments-search');
            const data = await response.json();

            if (data.success) {
                const selectElement = document.getElementById('savedInstrumentFilter');
                selectElement.innerHTML = '<option value="">All Instruments</option>';

                data.instruments.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.key;
                    option.textContent = `${inst.name} (${inst.key})`;
                    selectElement.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading saved instruments:', error);
        }
    }

    // Export to CSV
    function exportToCsv() {
        if (currentData.length === 0) {
            alert('No data to export');
            return;
        }

        // Create CSV content
        const headers = ['timestamp', 'open', 'high', 'low', 'close', 'volume'];
        let csvContent = headers.join(',') + '\n';

        currentData.forEach(row => {
            const values = headers.map(header => {
                let value = row[header];
                if (typeof value === 'string' && value.includes(',')) {
                    value = `"${value}"`; // Escape commas in values
                }
                return value;
            });
            csvContent += values.join(',') + '\n';
        });

        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `ohlcv_data_${Date.now()}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Toggle table/chart view
    function toggleTableView() {
        const btn = document.getElementById('toggleViewBtn');
        const isChartView = btn.innerHTML.includes('Table View');

        if (isChartView) {
            // Switch to table view
            btn.innerHTML = '<i class="fas fa-chart-bar mr-1"></i> Chart View';
            document.getElementById('dataTable').parentElement.parentElement.classList.remove('hidden');
        } else {
            // Switch to chart view
            btn.innerHTML = '<i class="fas fa-table mr-1"></i> Table View';
            document.getElementById('dataTable').parentElement.parentElement.classList.add('hidden');

            // TODO: Implement chart view using Chart.js or similar
            alert('Chart view would be implemented here using Chart.js or similar library');
        }
    }

    // Show loading indicator
    function showLoading(show) {
        const loader = document.getElementById('loadingIndicator');
        if (show) {
            loader.classList.remove('hidden');
        } else {
            loader.classList.add('hidden');
        }
    }

    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        errorText.textContent = message;
        errorDiv.classList.remove('hidden');

        // Hide after 5 seconds
        setTimeout(() => {
            errorDiv.classList.add('hidden');
        }, 5000);
    }

    // Show success message
    function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        const successText = document.getElementById('successText');

        successText.textContent = message;
        successDiv.classList.remove('hidden');

        // Hide after 5 seconds
        setTimeout(() => {
            successDiv.classList.add('hidden');
        }, 5000);
    }

    // Hide all messages
    function hideMessages() {
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('successMessage').classList.add('hidden');
    }

    // Load tables function (existing)
    async function loadTables() {
        const res = await fetch('{{ url_for("database.get_tables") }}');
        const data = await res.json();
        const list = document.getElementById('table-list');

        list.innerHTML = data.tables.map(t => `
            <button onclick="previewTable('${t}')" class="w-full text-left px-4 py-3 rounded-xl hover:bg-slate-700/50 transition-colors group flex items-center">
                <i class="fas fa-table mr-3 text-slate-500 group-hover:text-blue-400"></i>
                <span class="text-sm font-medium text-slate-300 group-hover:text-white">${t}</span>
            </button>
        `).join('');
    }

    // Preview table function (existing)
    async function previewTable(tableName) {
        document.getElementById('selected-table-name').textContent = tableName;
        // In a real app, you'd fetch schema info here
        const body = document.getElementById('table-preview-body');
        body.innerHTML = `<tr><td colspan="4" class="px-6 py-20 text-center text-slate-400 italic">Fetching schema for ${tableName}...</td></tr>`;

        // Mocking table structure for demo
        setTimeout(() => {
            body.innerHTML = `
                <tr><td class="px-6 py-4 font-mono text-blue-400">id</td><td class="px-6 py-4">INTEGER</td><td class="px-6 py-4">NO</td><td class="px-6 py-4">PRIMARY KEY</td></tr>
                <tr><td class="px-6 py-4 font-mono text-blue-400">symbol</td><td class="px-6 py-4">VARCHAR</td><td class="px-6 py-4">NO</td><td class="px-6 py-4">-</td></tr>
                <tr><td class="px-6 py-4 font-mono text-blue-400">price</td><td class="px-6 py-4">DOUBLE</td><td class="px-6 py-4">YES</td><td class="px-6 py-4">0.0</td></tr>
                <tr><td class="px-6 py-4 font-mono text-blue-400">created_at</td><td class="px-6 py-4">TIMESTAMP</td><td class="px-6 py-4">NO</td><td class="px-6 py-4">NOW()</td></tr>
            `;
            document.getElementById('table-stats').textContent = '1,240 Rows • 156 KB';
        }, 300);
    }

    // Add event listeners for filter changes
    document.getElementById('savedInstrumentFilter').addEventListener('change', applyFilters);
    document.getElementById('savedFromDateFilter').addEventListener('change', applyFilters);
    document.getElementById('savedToDateFilter').addEventListener('change', applyFilters);

    // Apply filters function
    async function applyFilters() {
        const instrument = document.getElementById('savedInstrumentFilter').value;
        const fromDate = document.getElementById('savedFromDateFilter').value;
        const toDate = document.getElementById('savedToDateFilter').value;

        if (instrument) {
            await loadHistoricalData(instrument, fromDate || undefined, toDate || undefined, 1);
        }
    }
</script>
{% endblock %}
