{% extends "base.html" %}

{% block title %}Database Viewer - Trading Bot Pro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold">Database Viewer</h1>
            <p class="text-base-content/70">Browse and query your trading database</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Tables Sidebar -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-lg">Tables</h2>
                <div class="divider my-2"></div>
                <ul class="menu menu-sm bg-base-200 rounded-box w-full" id="tables-list">
                    {% for table in tables %}
                    <li>
                        <a href="#" onclick="selectTable('{{ table }}')" class="table-item" data-table="{{ table }}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125" />
                            </svg>
                            {{ table }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-3 space-y-6">
            <!-- Query Panel -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
                        </svg>
                        SQL Query
                    </h2>
                    <div class="divider my-2"></div>
                    <div class="form-control">
                        <textarea id="sql-query" class="textarea textarea-bordered h-24 font-mono text-sm"
                                  placeholder="SELECT * FROM table_name LIMIT 100"></textarea>
                    </div>
                    <div class="flex gap-2 mt-3">
                        <button class="btn btn-primary" onclick="runQuery()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
                            </svg>
                            Run Query
                        </button>
                        <button class="btn btn-ghost" onclick="clearQuery()">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Table Info -->
            <div id="table-info" class="card bg-base-100 shadow-xl hidden">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title" id="selected-table-name">-</h2>
                        <div class="flex gap-2">
                            <button class="btn btn-outline btn-sm" onclick="exportTable()">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="stats stats-horizontal shadow mt-4">
                        <div class="stat">
                            <div class="stat-title">Columns</div>
                            <div class="stat-value text-lg" id="table-columns">-</div>
                        </div>
                        <div class="stat">
                            <div class="stat-title">Rows</div>
                            <div class="stat-value text-lg" id="table-rows">-</div>
                        </div>
                    </div>

                    <!-- Schema -->
                    <div class="collapse collapse-arrow bg-base-200 mt-4">
                        <input type="checkbox" />
                        <div class="collapse-title font-medium">Table Schema</div>
                        <div class="collapse-content">
                            <table class="table table-xs" id="schema-table">
                                <thead>
                                    <tr>
                                        <th>Column</th>
                                        <th>Type</th>
                                        <th>Nullable</th>
                                        <th>Key</th>
                                    </tr>
                                </thead>
                                <tbody id="schema-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">Results</h2>
                        <span class="text-sm text-base-content/70" id="result-count">-</span>
                    </div>
                    <div class="divider my-2"></div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="table table-compact table-pin-rows w-full" id="results-table">
                            <thead id="results-thead">
                                <tr>
                                    <th>Select a table or run a query</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <tr>
                                    <td class="text-center text-base-content/50 py-8">
                                        No data to display
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-4" id="pagination-controls">
                        <div class="text-sm text-base-content/70">
                            Showing <span id="showing-from">0</span> - <span id="showing-to">0</span> of <span id="total-rows">0</span>
                        </div>
                        <div class="join">
                            <button class="join-item btn btn-sm" id="prev-btn" onclick="prevPage()" disabled>«</button>
                            <button class="join-item btn btn-sm">Page <span id="current-page">1</span></button>
                            <button class="join-item btn btn-sm" id="next-btn" onclick="nextPage()" disabled>»</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let selectedTable = null;
    let currentOffset = 0;
    const pageSize = 100;
    let totalRows = 0;

    async function selectTable(tableName) {
        selectedTable = tableName;
        currentOffset = 0;

        // Update UI
        document.querySelectorAll('.table-item').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.table === tableName) {
                el.classList.add('active');
            }
        });

        document.getElementById('table-info').classList.remove('hidden');
        document.getElementById('selected-table-name').textContent = tableName;

        // Set query
        document.getElementById('sql-query').value = `SELECT * FROM ${tableName} LIMIT 100`;

        // Load schema and data
        await Promise.all([loadSchema(tableName), browseTable(tableName)]);
    }

    async function loadSchema(tableName) {
        try {
            const response = await fetch(`{{ url_for("database.schema", table_name="TABLE") }}`.replace('TABLE', tableName));
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            document.getElementById('table-columns').textContent = data.columns.length;

            const tbody = document.getElementById('schema-tbody');
            tbody.innerHTML = data.columns.map(col => `
                <tr>
                    <td class="font-mono text-xs">${col.name}</td>
                    <td class="text-xs">${col.type}</td>
                    <td>${col.nullable ? 'Yes' : 'No'}</td>
                    <td>${col.key || '-'}</td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Error loading schema:', error);
        }
    }

    async function browseTable(tableName) {
        try {
            const url = `{{ url_for("database.browse", table_name="TABLE") }}`.replace('TABLE', tableName);
            const response = await fetch(`${url}?limit=${pageSize}&offset=${currentOffset}`);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            totalRows = data.total;
            document.getElementById('table-rows').textContent = totalRows.toLocaleString();

            renderResults(data.columns, data.data);
            updatePagination(data.total);

        } catch (error) {
            console.error('Error browsing table:', error);
            showToast('Error loading table: ' + error.message, 'error');
        }
    }

    async function runQuery() {
        const sql = document.getElementById('sql-query').value.trim();
        if (!sql) {
            showToast('Please enter a query', 'warning');
            return;
        }

        try {
            const response = await fetch('{{ url_for("database.query") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sql })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            renderResults(data.columns, data.data);
            document.getElementById('result-count').textContent = `${data.row_count} rows`;
            document.getElementById('pagination-controls').classList.add('hidden');

            showToast(`Query returned ${data.row_count} rows`, 'success');

        } catch (error) {
            console.error('Query error:', error);
            showToast('Query error: ' + error.message, 'error');
        }
    }

    function renderResults(columns, data) {
        const thead = document.getElementById('results-thead');
        const tbody = document.getElementById('results-tbody');

        // Headers
        thead.innerHTML = `<tr>${columns.map(col => `<th>${col}</th>`).join('')}</tr>`;

        // Data
        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${columns.length}" class="text-center text-base-content/50 py-8">No data</td></tr>`;
            return;
        }

        tbody.innerHTML = data.map(row => `
            <tr class="hover">
                ${columns.map(col => {
                    let val = row[col];
                    if (val === null || val === undefined) val = '<span class="text-base-content/30">NULL</span>';
                    else if (typeof val === 'boolean') val = val ? '✓' : '✗';
                    else if (typeof val === 'object') val = JSON.stringify(val);
                    else val = String(val).substring(0, 100);
                    return `<td class="text-xs">${val}</td>`;
                }).join('')}
            </tr>
        `).join('');

        document.getElementById('result-count').textContent = `${data.length} rows`;
    }

    function updatePagination(total) {
        const from = currentOffset + 1;
        const to = Math.min(currentOffset + pageSize, total);

        document.getElementById('showing-from').textContent = total > 0 ? from : 0;
        document.getElementById('showing-to').textContent = to;
        document.getElementById('total-rows').textContent = total;
        document.getElementById('current-page').textContent = Math.floor(currentOffset / pageSize) + 1;

        document.getElementById('prev-btn').disabled = currentOffset === 0;
        document.getElementById('next-btn').disabled = currentOffset + pageSize >= total;

        document.getElementById('pagination-controls').classList.remove('hidden');
    }

    function prevPage() {
        if (currentOffset >= pageSize) {
            currentOffset -= pageSize;
            browseTable(selectedTable);
        }
    }

    function nextPage() {
        if (currentOffset + pageSize < totalRows) {
            currentOffset += pageSize;
            browseTable(selectedTable);
        }
    }

    function clearQuery() {
        document.getElementById('sql-query').value = '';
    }

    function exportTable() {
        if (!selectedTable) return;
        window.location.href = `{{ url_for("database.export", table_name="TABLE") }}`.replace('TABLE', selectedTable);
    }
</script>
{% endblock %}
