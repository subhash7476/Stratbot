{% extends "base.html" %}

{% block title %}Options Analyzer - Trading Bot Pro{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold">Options Analyzer</h1>
            <p class="text-base-content/70">Analyze option chains, Greeks, and strategies</p>
        </div>
    </div>

    <!-- Symbol Selector -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex flex-wrap items-end gap-4">
                <div class="form-control w-full max-w-xs">
                    <label class="label">
                        <span class="label-text">Select Underlying</span>
                    </label>
                    <select id="underlying-select" class="select select-bordered w-full" onchange="onUnderlyingChange()">
                        <option value="">-- Select Symbol --</option>
                        {% for symbol in underlyings %}
                        <option value="{{ symbol }}">{{ symbol }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-control w-full max-w-xs">
                    <label class="label">
                        <span class="label-text">Expiry Date</span>
                    </label>
                    <select id="expiry-select" class="select select-bordered w-full" onchange="loadOptionChain()" disabled>
                        <option value="">-- Select Expiry --</option>
                    </select>
                </div>

                <button class="btn btn-primary" id="load-chain-btn" onclick="loadOptionChain()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                    Load Chain
                </button>
            </div>
        </div>
    </div>

    <!-- Greeks Calculator -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 15.75V18m-7.5-6.75h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V13.5zm0 2.25h.008v.008H8.25v-.008zm0 2.25h.008v.008H8.25V18zm2.498-6.75h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V13.5zm0 2.25h.007v.008h-.007v-.008zm0 2.25h.007v.008h-.007V18zm2.504-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zm0 2.25h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V18zm2.498-6.75h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V13.5zM8.25 6h7.5v2.25h-7.5V6zM12 2.25c-1.892 0-3.758.11-5.593.322C5.307 2.7 4.5 3.65 4.5 4.757V19.5a2.25 2.25 0 002.25 2.25h10.5a2.25 2.25 0 002.25-2.25V4.757c0-1.108-.806-2.057-1.907-2.185A48.507 48.507 0 0012 2.25z" />
                    </svg>
                    Greeks Calculator
                </h2>
                <div class="divider my-2"></div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Spot Price</span></label>
                        <input type="number" id="calc-spot" class="input input-bordered input-sm" value="20000" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Strike</span></label>
                        <input type="number" id="calc-strike" class="input input-bordered input-sm" value="20000" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Days to Expiry</span></label>
                        <input type="number" id="calc-days" class="input input-bordered input-sm" value="30" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">IV (%)</span></label>
                        <input type="number" id="calc-iv" class="input input-bordered input-sm" value="20" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Risk-Free Rate (%)</span></label>
                        <input type="number" id="calc-rf" class="input input-bordered input-sm" value="6" />
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Option Type</span></label>
                        <select id="calc-type" class="select select-bordered select-sm">
                            <option value="CE">Call (CE)</option>
                            <option value="PE">Put (PE)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-secondary mt-4" onclick="calculateGreeks()">
                    Calculate Greeks
                </button>
            </div>
        </div>

        <!-- Greeks Results -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Greeks Results</h2>
                <div class="divider my-2"></div>

                <div class="stats stats-vertical lg:stats-horizontal shadow w-full" id="greeks-results">
                    <div class="stat">
                        <div class="stat-title">Premium</div>
                        <div class="stat-value text-lg" id="greek-premium">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Delta</div>
                        <div class="stat-value text-lg" id="greek-delta">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Gamma</div>
                        <div class="stat-value text-lg" id="greek-gamma">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Theta</div>
                        <div class="stat-value text-lg" id="greek-theta">-</div>
                    </div>
                    <div class="stat">
                        <div class="stat-title">Vega</div>
                        <div class="stat-value text-lg" id="greek-vega">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Option Chain -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <h2 class="card-title">Option Chain</h2>
                <div id="chain-spot" class="badge badge-lg badge-primary">Spot: -</div>
            </div>
            <div class="divider my-2"></div>

            <div class="overflow-x-auto">
                <table class="table table-compact w-full" id="chain-table">
                    <thead>
                        <tr class="bg-base-200">
                            <th colspan="5" class="text-center text-success bg-success/10">CALLS</th>
                            <th class="text-center bg-base-300">Strike</th>
                            <th colspan="5" class="text-center text-error bg-error/10">PUTS</th>
                        </tr>
                        <tr>
                            <th class="text-xs">OI</th>
                            <th class="text-xs">Chg OI</th>
                            <th class="text-xs">Volume</th>
                            <th class="text-xs">IV</th>
                            <th class="text-xs">LTP</th>
                            <th class="text-xs text-center font-bold">Strike</th>
                            <th class="text-xs">LTP</th>
                            <th class="text-xs">IV</th>
                            <th class="text-xs">Volume</th>
                            <th class="text-xs">Chg OI</th>
                            <th class="text-xs">OI</th>
                        </tr>
                    </thead>
                    <tbody id="chain-tbody">
                        <tr>
                            <td colspan="11" class="text-center text-base-content/50 py-8">
                                Select a symbol and expiry to load option chain
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ATM Straddle -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">ATM Straddle Analysis</h2>
            <div class="divider my-2"></div>

            <div id="straddle-info" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">ATM Strike</div>
                    <div class="stat-value text-lg" id="straddle-strike">-</div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">Straddle Premium</div>
                    <div class="stat-value text-lg" id="straddle-premium">-</div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">IV (Avg)</div>
                    <div class="stat-value text-lg" id="straddle-iv">-</div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">Expected Move</div>
                    <div class="stat-value text-lg" id="straddle-move">-</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentSymbol = null;
    let currentExpiry = null;

    async function onUnderlyingChange() {
        const symbol = document.getElementById('underlying-select').value;
        const expirySelect = document.getElementById('expiry-select');
        const loadBtn = document.getElementById('load-chain-btn');

        if (!symbol) {
            expirySelect.disabled = true;
            loadBtn.disabled = true;
            return;
        }

        currentSymbol = symbol;

        // Load expiries
        try {
            const response = await fetch(`{{ url_for("options.expiries", symbol="SYMBOL") }}`.replace('SYMBOL', symbol));
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            expirySelect.innerHTML = '<option value="">-- Select Expiry --</option>';
            data.expiries.forEach(exp => {
                expirySelect.innerHTML += `<option value="${exp}">${exp}</option>`;
            });

            expirySelect.disabled = false;
            loadBtn.disabled = false;

        } catch (error) {
            console.error('Error loading expiries:', error);
            showToast('Failed to load expiries', 'error');
        }
    }

    async function loadOptionChain() {
        const symbol = document.getElementById('underlying-select').value;
        const expiry = document.getElementById('expiry-select').value;

        if (!symbol) {
            showToast('Please select a symbol', 'warning');
            return;
        }

        currentSymbol = symbol;
        currentExpiry = expiry;

        const btn = document.getElementById('load-chain-btn');
        btn.classList.add('loading');

        try {
            let url = `{{ url_for("options.option_chain", symbol="SYMBOL") }}`.replace('SYMBOL', symbol);
            if (expiry) {
                url += `?expiry=${expiry}`;
            }

            const response = await fetch(url);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Failed to load chain');
            }

            renderOptionChain(data.chain);
            loadStraddleAnalysis(symbol, expiry);

        } catch (error) {
            console.error('Error loading option chain:', error);
            showToast('Failed to load option chain: ' + error.message, 'error');
        } finally {
            btn.classList.remove('loading');
        }
    }

    function renderOptionChain(chain) {
        const tbody = document.getElementById('chain-tbody');

        if (!chain || !chain.strikes || chain.strikes.length === 0) {
            tbody.innerHTML = `<tr><td colspan="11" class="text-center text-base-content/50 py-8">No data available</td></tr>`;
            return;
        }

        // Update spot price
        document.getElementById('chain-spot').textContent = `Spot: ${formatPrice(chain.spot)}`;

        // Find ATM strike
        const atmStrike = chain.strikes.reduce((prev, curr) =>
            Math.abs(curr.strike - chain.spot) < Math.abs(prev.strike - chain.spot) ? curr : prev
        ).strike;

        tbody.innerHTML = chain.strikes.map(row => {
            const isATM = row.strike === atmStrike;
            const isITM_CE = row.strike < chain.spot;
            const isITM_PE = row.strike > chain.spot;

            return `
                <tr class="${isATM ? 'bg-primary/20' : ''}">
                    <td class="${isITM_CE ? 'bg-success/10' : ''} text-xs font-mono">${formatNumber(row.call_oi)}</td>
                    <td class="${isITM_CE ? 'bg-success/10' : ''} text-xs font-mono ${row.call_oi_change > 0 ? 'text-success' : 'text-error'}">${formatNumber(row.call_oi_change)}</td>
                    <td class="${isITM_CE ? 'bg-success/10' : ''} text-xs font-mono">${formatNumber(row.call_volume)}</td>
                    <td class="${isITM_CE ? 'bg-success/10' : ''} text-xs font-mono">${row.call_iv ? row.call_iv.toFixed(1) + '%' : '-'}</td>
                    <td class="${isITM_CE ? 'bg-success/10' : ''} text-xs font-mono font-bold">${formatPrice(row.call_ltp)}</td>
                    <td class="text-center font-bold ${isATM ? 'text-primary' : ''}">${row.strike}</td>
                    <td class="${isITM_PE ? 'bg-error/10' : ''} text-xs font-mono font-bold">${formatPrice(row.put_ltp)}</td>
                    <td class="${isITM_PE ? 'bg-error/10' : ''} text-xs font-mono">${row.put_iv ? row.put_iv.toFixed(1) + '%' : '-'}</td>
                    <td class="${isITM_PE ? 'bg-error/10' : ''} text-xs font-mono">${formatNumber(row.put_volume)}</td>
                    <td class="${isITM_PE ? 'bg-error/10' : ''} text-xs font-mono ${row.put_oi_change > 0 ? 'text-success' : 'text-error'}">${formatNumber(row.put_oi_change)}</td>
                    <td class="${isITM_PE ? 'bg-error/10' : ''} text-xs font-mono">${formatNumber(row.put_oi)}</td>
                </tr>
            `;
        }).join('');
    }

    async function loadStraddleAnalysis(symbol, expiry) {
        try {
            let url = `{{ url_for("options.straddle_analysis", symbol="SYMBOL") }}`.replace('SYMBOL', symbol);
            if (expiry) url += `?expiry=${expiry}`;

            const response = await fetch(url);
            const data = await response.json();

            if (data.success && data.straddle) {
                document.getElementById('straddle-strike').textContent = data.straddle.strike;
                document.getElementById('straddle-premium').textContent = formatPrice(data.straddle.premium);
                document.getElementById('straddle-iv').textContent = data.straddle.iv ? data.straddle.iv.toFixed(1) + '%' : '-';
                document.getElementById('straddle-move').textContent = data.straddle.expected_move ? 'Â±' + data.straddle.expected_move.toFixed(1) + '%' : '-';
            }

        } catch (error) {
            console.error('Error loading straddle:', error);
        }
    }

    async function calculateGreeks() {
        const params = {
            spot: parseFloat(document.getElementById('calc-spot').value),
            strike: parseFloat(document.getElementById('calc-strike').value),
            expiry_days: parseInt(document.getElementById('calc-days').value),
            iv: parseFloat(document.getElementById('calc-iv').value),
            risk_free: parseFloat(document.getElementById('calc-rf').value),
            option_type: document.getElementById('calc-type').value
        };

        try {
            const response = await fetch('{{ url_for("options.calculate_greeks") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error);
            }

            const g = data.greeks;
            document.getElementById('greek-premium').textContent = formatPrice(g.premium);
            document.getElementById('greek-delta').textContent = g.delta?.toFixed(4) || '-';
            document.getElementById('greek-gamma').textContent = g.gamma?.toFixed(6) || '-';
            document.getElementById('greek-theta').textContent = g.theta?.toFixed(4) || '-';
            document.getElementById('greek-vega').textContent = g.vega?.toFixed(4) || '-';

            showToast('Greeks calculated', 'success');

        } catch (error) {
            console.error('Error calculating Greeks:', error);
            showToast('Failed to calculate Greeks: ' + error.message, 'error');
        }
    }

    function formatNumber(val) {
        if (val === null || val === undefined) return '-';
        return parseInt(val).toLocaleString('en-IN');
    }
</script>
{% endblock %}
